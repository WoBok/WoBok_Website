<html>

<body>
    <button id="getFileList">获得文件列表</button>
    <div id="fileListContent"></div>
    <div id="markdownContent"></div>
</body>

</html>

<style>
    ul {
        list-style-type: none;
    }

    .folder-name-node-content {
        color: white;
        background-color: black;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    function BindClickEventById(id, event) {
        document.getElementById(id).addEventListener("click", event);
    }
    async function FetchText(url) {
        try {
            const response = await fetch(url);
            if (response.ok) {
                return response.text();
            } else {
                console.log("Fetch text failed: " + response.statusText);
                return null;
            }
        } catch (error) {
            console.log(error);
        }
    }
    async function FecthJson(url) {
        try {
            const response = await fetch(url);
            if (response.ok) {
                return response.json();
            } else {
                console.log("Fetch json failed: " + response.statusText);
                return null;
            }
        } catch (error) {
            console.log(error);
        }
    }
</script>

<script>
    const renderer = {
        image(href, title, text) {
            return `<img src="${markdownPath}/${href}" alt="${text}">`;
        }
    }
</script>

<script>

    marked.use({ renderer });

    const rootPath = "Markdowns";

    var markdownPath = rootPath;

    async function GetFileList(path) {
        var url = `/api/FileList/${path}`;
        return await FecthJson(url);
    }

    async function GetMarkdownText(fileName) {
        var url = `/api/MarkdownLoader/${fileName}`;
        return await FetchText(url);
    }

    function ParseMarkdown(md) {
        document.getElementById("markdownContent").innerHTML = marked.parse(md);
    }

    function DisplayMarkdown(fileName) {
        GetMarkdownText(fileName).then(text => ParseMarkdown(text));
    }

    function BindFileNodeClickEvent(fileNameNode) {
        fileNameNode.addEventListener("click", () => {
            var path = GetMarkdownPath(fileNameNode);
            if (path) {
                markdownPath = `${rootPath}/${path}`;
            }
            var filePath = fileNameNode.title;
            if (path) {
                filePath = `${path}/${fileNameNode}`
            }
            DisplayMarkdown(filePath);
        });
    }

    function GetMarkdownPath(fileNameNode) {
        var path;
        var nodeParent = fileNameNode.parentNode;
        while (nodeParent && nodeParent.title != "FileListRoot") {
            path = `${nodeParent.title}/${path}`;
        }
        return path;
    }

    function DisplayFileNode(fileNames, parent) {
        for (let p of fileNames) {
            let liNode = document.createElement("li");
            let fileNameNode = document.createTextNode("﹥" + p);
            liNode.title = p;
            liNode.appendChild(fileNameNode);

            BindFileNodeClickEvent(liNode);

            parent.appendChild(liNode);
        }
    }

    function DisplayFolderNode(folderNames, parent) {
        for (let p of folderNames) {
            let liNode = document.createElement("li");
            let folderNameNodeContent = document.createTextNode("＞" + p);
            let folderNameNode = document.createElement("span");
            folderNameNode.appendChild(folderNameNodeContent);
            folderNameNode.className = "folder-name-node-content";
            liNode.title = p;
            liNode.appendChild(folderNameNode);

            parent.appendChild(liNode);


            liNode.addEventListener("click", () => {
                DisplayMarkdown(p);
            });
        }
    }

    function DisplayPathNode(pathNode, parentNode) {
        DisplayFileNode(pathNode["files"], parentNode);
        DisplayFolderNode(pathNode["folders"], parentNode);
    }

    function DisplayRootPathNode(pathNode) {
        var fileListContent = document.getElementById("fileListContent");
        fileListContent.innerText = "";

        var ulNode = document.createElement("ul");
        fileListContent.appendChild(ulNode);

        var listRootNode = document.createElement("div");
        listRootNode.title = "FileListRoot";
        ulNode.appendChild(listRootNode);

        DisplayPathNode(pathNode, listRootNode);
    }

    BindClickEventById("getFileList", () => {
        GetFileList("*").then(json => DisplayRootPathNode(json));
    });
</script>